<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-12">
            <div id="courseFormWrapper">
                <div class="jumbotron">
                    <h1>Course Form</h1>
                    <form action="/courses" id="courseForm">
                        <div class="form-group">
                            <label>Code:</label>
                            <input type="text" class="form-control" name="code" placeholder="Code">
                        </div>
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" class="form-control" name="name" placeholder="Name">
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>

            </div>
            <div id="studentFormWrapper">
                <div class="jumbotron">
                    <h1>Student Form</h1>
                    <form id="studentForm" action="/students">
                        <div class="form-group">
                            <label>Last Name:</label>
                            <input type="text" class="form-control" name="lastName" placeholder="Last Name">
                        </div>
                        <div class="form-group">
                            <label>First Name:</label>
                            <input type="text" class="form-control" name="firstName" placeholder="First Name">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" class="form-control" name="email" placeholder="Email">
                        </div>
                        <div class="form-group">
                            <label>Major:</label>
                            <input type="text" class="form-control" name="major" placeholder="Major">
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>

            </div>
        </div>
        <div class="col-12 mx-auto">
            <div id="accordion" class="mt-5">
                <div class="card">
                    <div class="card-header">
                        <a class="card-link" data-toggle="collapse" href="#collapseOne">
                            Courses
                        </a>
                    </div>
                    <div id="collapseOne" class="collapse show" data-parent="#accordion">
                        <div class="card-body">
                            Lorem ipsum..
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <a class="collapsed card-link" data-toggle="collapse" href="#collapseTwo">
                            Students
                        </a>
                    </div>
                    <div id="collapseTwo" class="collapse" data-parent="#accordion">
                        <div class="card-body">
                            Lorem ipsum..
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var base_url = "http://localhost:8080"

    function removeAllChildNodes(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }

    async function getAllData(selector, url, attrs) {
        selector.innerHTML = ""
        await fetch(base_url + url)
            .then(response => response.json())
            .then(data => {
                let tableData = ""
                for (let index = 0; index < data.length; index++) {
                    const element = data[index];
                    let row = ""
                    for (const key in element) {
                        if (Object.hasOwnProperty.call(element, key)) {
                            const innerElement = element[key];
                            if (attrs.includes(key)) {
                                row += `<td>${innerElement || "Not given"}</td>`
                            }
                        }
                    }

                    tableData += `<tr>${row}<td><button class="delete btn btn-danger" data-entity="${url}" data-id="${element.id}"> Delete</button></td></tr>`
                }

                let headers = attrs.map(attr => (`<th>${attr.toUpperCase()}</th>`)).join("");
                selector.innerHTML = `<table class="table"><thead><tr>${headers}<th>Actions</th></tr></thead><tbody>${tableData}</tbody></table>`
                deleteListener()
            });
    }

    function deleteListener() {
        let buttons = document.querySelectorAll("button.delete")
        for (let i = 0; i < buttons.length; i++) {
            buttons[i].addEventListener("click", async function (e) {
                e.preventDefault()
                const element = e.target
                const id = element.dataset.id
                const entity = element.dataset.entity
                const confirmation = confirm("Want to delete?");
                if (confirmation) {
                    const rawResponse = await fetch(`${base_url}${entity}/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    }).then(res => res.text());
                    getAllData(coursesBody, "/courses", ["id", "code", "name"])
                    getAllData(studentsBody, "/students", ["id", "lastName", "firstName", "major", "email"])
                }

            });
        }
    }

    var coursesBox = document.getElementById("collapseOne")
    var studentsBox = document.getElementById("collapseTwo")
    var courseFormWrapper = document.querySelector("#courseFormWrapper")
    var studentFormWrapper = document.querySelector("#studentFormWrapper")
    var coursesBody = coursesBox.querySelector(".card-body")
    var studentsBody = studentsBox.querySelector(".card-body")
    getAllData(coursesBody, "/courses", ["id", "code", "name"]).then(
        () => {
            const courseForm = document.getElementById("courseForm")
            courseForm.addEventListener("submit", async function (e) {
                e.preventDefault()
                const data = new FormData(e.target);
                const sendedData = Object.fromEntries(data.entries());
                const rawResponse = await fetch(`${base_url}/courses`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sendedData)
                }).then(res => res.text());
                if (rawResponse === "New course saved") {
                    e.target.reset()
                    alert(rawResponse)
                    getAllData(coursesBody, "/courses", ["id", "code", "name"])
                } else {
                    alert("Error!")
                }
            })
        }
    )
    getAllData(studentsBody, "/students", ["id", "lastName", "firstName", "major", "email"]).then(
        () => {
            const studentForm = document.getElementById("studentForm")
            studentForm.addEventListener("submit", async function (e) {
                e.preventDefault()
                const data = new FormData(e.target);
                const sendedData = Object.fromEntries(data.entries());
                const rawResponse = await fetch(`${base_url}/students`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({...sendedData, coursesTaken: []})
                }).then(res => res.text());
                if (rawResponse === "New student saved") {
                    e.target.reset()
                    alert(rawResponse)
                    getAllData(studentsBody, "/students", ["id", "lastName", "firstName", "major", "email"])
                } else {
                    alert("Error!")
                }
            })
        }
    )

</script>
</body>
</html>